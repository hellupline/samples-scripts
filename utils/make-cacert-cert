#!/bin/bash

# Usage:
# make-self-cacert "hellupline.dev"

# set -x # verbose
set -o pipefail # exit on pipeline error
set -e # exit on error
set -u # variable must exist

die () {
    echo >&2 "$@"
    exit 1
}

[ "$#" -eq 1 ] || die "1 argument required, $# provided"

DOMAIN=${1}

mkdir -p tls-certs

# create rootca certs
openssl genrsa -out tls-certs/rootca.key 4096
openssl req -x509 -new -sha256 -days 3650 \
    -key tls-certs/rootca.key -out tls-certs/rootca.cert \
    -subj "/O=${DOMAIN}"

# create application certs
openssl genrsa -out tls-certs/service.key 4096
openssl req -new -sha256 -days 3650 \
    -addext "subjectAltName = DNS:localhost,IP:::1,IP:127.0.0.1" \
    -key tls-certs/service.key -out tls-certs/service.csr \
    -subj "/O=${DOMAIN}/CN=localhost"
openssl x509 -req -sha256 \
    -CA tls-certs/rootca.cert -CAkey tls-certs/rootca.key -CAcreateserial \
    -in tls-certs/service.csr -out tls-certs/service.pem \
    -extfile <( \
        echo 'authorityKeyIdentifier=keyid,issuer'; \
        echo 'basicConstraints=CA:FALSE'; \
        echo 'keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment'; \
        echo "subjectAltName = DNS:${DOMAIN},IP:127.0.0.1"; \
    )
